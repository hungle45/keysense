---
phase: 03.1-polish
plan: 02
subsystem: game
tags: [pitch-detection, hit-detection, rms, volume-gate, clarity-gate]

# Dependency graph
requires:
  - phase: 03-game-loop
    provides: pitch detection, hit detection hook
provides:
  - Wait Mode hit detection with Strong Input Gate
  - PitchResult with RMS field for volume tracking
  - Decay detection for octave jump artifact filtering
affects: [game-screen, pitch-detection]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Strong Input Gate pattern (volume + clarity thresholds)
    - Peak RMS tracking for decay detection

key-files:
  created: []
  modified:
    - src/types/pitch.ts
    - src/hooks/usePitchDetection.ts
    - src/hooks/useHitDetection.ts

key-decisions:
  - "Strong Input Gate requires both RMS >= 0.01 AND clarity >= 0.85"
  - "150ms sustain duration (reduced from 200ms for responsiveness)"
  - "Decay detection at 30% RMS drop from peak filters octave artifacts"
  - "Visual feedback unchanged - already Wait Mode compatible"

patterns-established:
  - "Strong Input Gate: volume AND clarity must pass before processing"
  - "Peak RMS tracking: record highest RMS to detect decay"

requirements-completed: [GAME-04]

# Metrics
duration: 3min
completed: 2026-03-01
---

# Phase 3.1 Plan 02: Wait Mode Hit Detection Summary

**Wait Mode hit detection with Strong Input Gate (volume + clarity), 150ms sustain, and decay filtering to prevent false positives from noise and octave jump artifacts**

## Performance

- **Duration:** 3 min
- **Started:** 2026-03-01T05:47:23Z
- **Completed:** 2026-03-01T05:50:09Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- Extended PitchResult with RMS field for downstream volume tracking
- Implemented Strong Input Gate requiring both volume (RMS >= 0.01) and clarity (>= 0.85)
- Added decay detection to filter octave jump artifacts during note decay
- Reduced sustain duration from 200ms to 150ms for better responsiveness
- Verified visual feedback already Wait Mode compatible (no changes needed)

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend PitchResult to include RMS** - `2ffd58c` (feat)
2. **Task 2: Implement Wait Mode hit detection** - `3509840` (feat)
3. **Task 3: Update visual feedback** - No commit (verification only - existing code already correct)

**Plan metadata:** `a4bd3c9` (docs: complete plan)

## Files Created/Modified

- `src/types/pitch.ts` - Added `rms: number` field to PitchResult interface
- `src/hooks/usePitchDetection.ts` - Included currentRMS in pitch detection result
- `src/hooks/useHitDetection.ts` - Complete rewrite with Strong Input Gate, decay detection, and 150ms sustain

## Decisions Made

1. **Strong Input Gate thresholds:**
   - RMS >= 0.01 (~-40dB) for minimum volume
   - Clarity >= 0.85 for minimum pitch confidence
   - Both must pass to start/continue tracking

2. **Decay detection:**
   - Track peak RMS during note sustain
   - If current RMS drops to < 70% of peak, treat as decay artifact
   - Prevents octave jump harmonics from triggering false hits

3. **Sustain duration:**
   - Reduced from 200ms to 150ms for better responsiveness
   - Still long enough to filter brief noise bursts

4. **Visual feedback:**
   - Existing implementation already correct for Wait Mode
   - No changes needed - green only on hit, red only when scrolled past

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed successfully.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Wait Mode hit detection complete and ready for testing
- Phase 3.1 plans complete, ready for verification
- Manual testing recommended: noise rejection, octave artifact filtering, sustained note detection

---
*Phase: 03.1-polish*
*Completed: 2026-03-01*
