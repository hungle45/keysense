---
phase: 03.1-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/game/GrandStaff.tsx
  - src/components/game/ScrollingNote.tsx
  - src/screens/GameScreen.tsx
  - src/hooks/useGameSession.ts
autonomous: true
requirements: [GAME-03, GAME-05]

must_haves:
  truths:
    - "Grand staff displays at proper width with treble clef on G-line and bass clef on F-line"
    - "3-4 circular notes are visible on screen simultaneously"
    - "Timer counts down from session duration to 0:00 in real-time"
    - "Timing line is visible as a colored vertical line"
  artifacts:
    - path: "src/components/game/GrandStaff.tsx"
      provides: "Fixed clef positioning, minimum width, valid stroke color"
      contains: "min-w-"
    - path: "src/components/game/ScrollingNote.tsx"
      provides: "Circular note shape"
      contains: "w-5 h-5"
    - path: "src/screens/GameScreen.tsx"
      provides: "Faster spawn interval for 3-4 notes"
      contains: "spawnIntervalMs"
    - path: "src/hooks/useGameSession.ts"
      provides: "TIMER_TICK action for re-renders"
      contains: "TIMER_TICK"
  key_links:
    - from: "src/hooks/useGameSession.ts"
      to: "remainingMs"
      via: "TIMER_TICK triggers re-render"
      pattern: "TIMER_TICK"
---

<objective>
Fix visual and timer issues from Phase 3 UAT.

Purpose: Users need a polished game experience with properly displayed staff, visible notes, and working countdown timer.
Output: Working grand staff display, circular notes with proper density, real-time countdown timer.
</objective>

<execution_context>
@/Volumes/External/Users/my_mac/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Volumes/External/Users/my_mac/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-game-loop/03-UAT.md

<interfaces>
<!-- Key types and constants the executor needs -->

From src/components/game/GrandStaff.tsx:
```typescript
export const STAFF_CONFIG = {
  lineSpacing: 10,       // pixels between staff lines
  staffHeight: 40,       // 4 spaces = 5 lines
  gap: 30,               // gap between treble and bass staff
  timingLinePosition: 80, // pixels from left edge where timing line is
};
```

From src/index.css (Tailwind v4):
```css
--color-primary: oklch(15% 0 0);
```
Note: Tailwind v4 uses `--color-primary` with oklch format, NOT `--primary` with hsl.

From src/types/game.ts:
```typescript
type GameAction = 
  | { type: 'CONFIGURE'; config: GameConfig }
  | { type: 'START_COUNTDOWN' }
  | { type: 'COUNTDOWN_TICK' }
  | { type: 'START_SESSION' }
  | { type: 'SPAWN_NOTE'; note: TargetNote }
  | { type: 'NOTE_HIT'; noteId: string; playedNote: string; playedOctave: number }
  | { type: 'NOTE_MISSED'; noteId: string }
  | { type: 'END_SESSION' }
  | { type: 'RESET' };
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix grand staff display (clefs, width, timing line)</name>
  <files>src/components/game/GrandStaff.tsx</files>
  <action>
Fix the grand staff display with these specific changes:

1. **Add minimum width to container:**
   - Add `min-w-[120px]` class to the outer div to ensure clefs don't get cut off

2. **Fix clef Y positions:**
   - Treble staff starts at Y=20 (line 43: `renderStaffLines(20)`)
   - Treble clef G-line is the second line from bottom = line index 3 = y = 20 + (3 * 10) = 50
   - Current treble clef y=35 is wrong. Change to y="50" (or slightly above like y="58" for visual centering)
   - Bass staff starts at Y = 20 + 40 + 30 = 90 (line 49: `renderStaffLines(90)`)
   - Bass clef F-line is the fourth line from bottom = line index 1 = y = 90 + (1 * 10) = 100
   - Current bass clef y=105 is close. Adjust to y="108" for better visual centering

3. **Increase clef font size:**
   - Change `text-2xl` to `text-5xl` for both clefs (Unicode musical symbols need large font to be legible)

4. **Fix timing line stroke color:**
   - Change `stroke="hsl(var(--primary))"` to `stroke="oklch(var(--color-primary))"` 
   - OR use a direct color like `stroke="#dc2626"` (red-600) for high visibility
   - Recommended: Use `className="stroke-red-500"` and remove the inline stroke attribute

5. **Update clef x positions:**
   - Move clefs to x="15" to give them more room after adding min-width
  </action>
  <verify>
    <automated>npm run build && npm run lint</automated>
  </verify>
  <done>
Grand staff renders with:
- Minimum width constraint (doesn't collapse on small screens)
- Treble clef centered on G-line (2nd line from bottom of treble staff)
- Bass clef centered on F-line (4th line from bottom of bass staff)  
- Large, legible clef symbols
- Visible red/primary colored timing line
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix note shape and spawn density</name>
  <files>src/components/game/ScrollingNote.tsx, src/screens/GameScreen.tsx</files>
  <action>
Fix note appearance and spawn rate:

**In ScrollingNote.tsx (line 83):**
1. Change `w-6 h-4` (24x16px oval) to `w-5 h-5` (20x20px circle)
2. Keep `rounded-full` class for perfect circle

**In GameScreen.tsx (line 72):**
1. Current formula: `spawnIntervalMs = (containerWidth / 3) / pixelsPerSecond * 1000`
   - At 800px width and 200px/s (medium speed): 800/3/200*1000 = 1333ms (~1.3s)
   - At 1000px and 100px/s (slow): 1000/3/100*1000 = 3333ms (~3.3s) â€” too slow!
   
2. Change spawn formula to ensure 3-4 notes visible:
   - Use `containerWidth / 5` instead of `containerWidth / 3`
   - This gives ~800ms intervals at medium speed on 800px screen
   - Formula: `const spawnIntervalMs = (containerWidth / 5) / pixelsPerSecond * 1000;`
   
3. Alternative: Use fixed interval based on scroll speed:
   ```typescript
   // Spawn interval tuned for 3-4 visible notes at each speed
   const SPAWN_INTERVALS: Record<ScrollSpeed, number> = {
     slow: 1500,    // 1.5s at 100px/s
     medium: 1000,  // 1.0s at 200px/s
     fast: 750,     // 0.75s at 300px/s
   };
   const spawnIntervalMs = SPAWN_INTERVALS[state.config.scrollSpeed];
   ```
   
Choose the fixed interval approach (cleaner, more predictable).
  </action>
  <verify>
    <automated>npm run build && npm run lint</automated>
  </verify>
  <done>
- Notes render as perfect circles (equal width/height)
- 3-4 notes visible on screen at once during gameplay
- Note density feels appropriate for the scroll speed
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix timer countdown display</name>
  <files>src/hooks/useGameSession.ts</files>
  <action>
Fix the timer not counting down by adding periodic state updates during gameplay:

**Root cause:** `remainingMs` is calculated via useMemo with deps `[state.status, state.startTime, state.config.duration]`. During 'running' state, none of these change, so the memo value never recalculates and the component never re-renders.

**Solution: Add a TIMER_TICK action that triggers re-renders:**

1. Add `currentTime` field to GameState type (after line 37):
   ```typescript
   currentTime: number;  // Updated periodically to trigger re-renders
   ```

2. Add to initialState:
   ```typescript
   currentTime: Date.now(),
   ```

3. Add TIMER_TICK action type to GameAction union (in types/game.ts if needed, or inline):
   ```typescript
   | { type: 'TIMER_TICK'; time: number }
   ```

4. Add reducer case (after COUNTDOWN_TICK case):
   ```typescript
   case 'TIMER_TICK':
     return { ...state, currentTime: action.time };
   ```

5. Add new interval in the hook (after the session timer interval, around line 204):
   ```typescript
   // Timer display: update currentTime to trigger re-renders
   useInterval(
     () => {
       dispatch({ type: 'TIMER_TICK', time: Date.now() });
     },
     state.status === 'running' ? 1000 : null
   );
   ```

6. Add `state.currentTime` to remainingMs useMemo deps (line 170):
   ```typescript
   }, [state.status, state.startTime, state.config.duration, state.currentTime]);
   ```

This ensures remainingMs recalculates every second during gameplay.

**Alternative (simpler but less pure):** Use useState with setInterval directly in component. But the reducer approach is cleaner and keeps state management centralized.
  </action>
  <verify>
    <automated>npm run build && npm run lint</automated>
  </verify>
  <done>
- Timer displays mm:ss format (e.g., "0:45")
- Timer updates every second during gameplay
- Timer counts down from session duration (60s or 300s) to 0:00
- Timer reaches 0:00 when session ends
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check:** `npm run build` succeeds
2. **Lint check:** `npm run lint` passes
3. **Visual verification (manual):**
   - Start a 1-minute session
   - Confirm grand staff has proper width
   - Confirm treble clef is on G-line, bass clef on F-line
   - Confirm timing line is visible (colored vertical line)
   - Confirm 3-4 circular notes visible at once
   - Confirm timer counts down from 1:00 to 0:00
</verification>

<success_criteria>
1. Grand staff displays at minimum width with correctly positioned clefs
2. Timing line is visible as a colored vertical line
3. Notes are circular (equal width/height)
4. 3-4 notes visible on screen simultaneously
5. Timer counts down in real-time from duration to 0
6. Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-polish/03.1-01-SUMMARY.md`
</output>
