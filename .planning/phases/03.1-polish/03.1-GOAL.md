# Phase 3.1: Polish

**Status:** Not Started
**Depends on:** Phase 3 (Game Loop) - Complete
**Type:** Polish/Fix phase (inserted after UAT)

---

## Goal

Fix UAT issues from Phase 3 and implement Wait Mode for robust hit detection. Users get a polished, visually correct game experience with reliable note detection that doesn't trigger on noise or artifacts.

---

## Context

Phase 3 UAT revealed 4 issues:
1. Grand staff display too narrow with mispositioned clefs
2. Only one note visible at a time, notes are oval not circular
3. Timer doesn't count down (stuck at 1:00)
4. Timing line invisible + hit detection unreliable

User also requested "Wait Mode" - a more robust hit detection approach that waits for sustained, confident input before triggering hits.

---

## Requirements Addressed

This is a polish phase - no new requirements from REQUIREMENTS.md. Addresses gaps in existing requirements:

| Original Req | Gap Being Fixed |
|--------------|-----------------|
| GAME-03 | Grand staff clef positioning and width |
| GAME-03 | Note shape (circular) and spawn density |
| GAME-05 | Timer countdown not updating |
| GAME-04 | Hit detection reliability (Wait Mode) |

---

## Success Criteria

**What must be TRUE when this phase completes:**

1. **Grand staff displays correctly**
   - Container has minimum width (min-w-[120px] or similar)
   - Treble clef positioned on G line (second line from bottom of treble staff)
   - Bass clef positioned on F line (fourth line from bottom of bass staff)
   - Clefs are large enough to be clearly visible (text-4xl or larger)
   - Timing line visible using valid Tailwind v4 oklch color

2. **Multiple circular notes visible**
   - 3-4 notes visible on screen simultaneously
   - Notes are circular (equal width/height, e.g., w-6 h-6)
   - Spawn interval allows appropriate note density

3. **Timer counts down in real-time**
   - Timer displays remaining time in mm:ss format
   - Timer updates every second during gameplay
   - Timer reaches 0:00 when session ends

4. **Wait Mode hit detection works reliably**
   - **Input Gate:** Detection only triggers when BOTH:
     - Volume/RMS above threshold (e.g., -40dB)
     - Pitch clarity/confidence above threshold (e.g., 0.9)
   - **Sustained Detection:** Correct MIDI note must be held for 150ms
   - **Decay Filtering:** Octave jumps ignored when volume is decreasing
   - **Visual Feedback:** Target note neutral while waiting, green on success, no red for glitches
   - No false positives from noise, coughs, talking, or harmonic artifacts

---

## Technical Scope

### Fix 1: Grand Staff Display
**Files:** `src/components/game/GrandStaff.tsx`
**Changes:**
- Add min-width to container
- Recalculate clef Y positions based on staff line coordinates
- Increase clef font size
- Fix timing line stroke to use valid oklch color

### Fix 2: Multiple Circular Notes
**Files:** `src/components/game/ScrollingNote.tsx`, `src/screens/GameScreen.tsx`
**Changes:**
- Change note dimensions to equal (w-6 h-6)
- Reduce spawn interval calculation to show 3-4 notes

### Fix 3: Timer Countdown
**Files:** `src/hooks/useGameSession.ts`
**Changes:**
- Add TIMER_TICK action to reducer
- Create interval that dispatches TIMER_TICK every 1000ms
- Ensure timer displays update during gameplay

### Fix 4: Wait Mode Hit Detection
**Files:** `src/hooks/useHitDetection.ts`, `src/hooks/usePitchDetector.ts` (if needed)
**Changes:**
- Implement two-gate input validation (volume AND clarity)
- Add 150ms sustain requirement for hits
- Implement decay detection to filter octave jumps
- Update visual feedback logic (green only, no red)
- Ensure pitch detector exposes RMS and clarity values

---

## Plans

Suggested decomposition into 2 plans:

### Plan 1: UI Fixes (Fixes 1-3)
- Grand staff width and clef positioning
- Circular notes with proper density
- Timer countdown fix
- Timing line visibility

### Plan 2: Wait Mode (Fix 4)
- Input gate implementation (volume + clarity thresholds)
- Sustained detection (150ms hold)
- Decay filtering for octave jumps
- Visual feedback updates

---

## Verification Approach

After implementation:
1. Visual inspection: Grand staff width, clef positions, circular notes, timing line
2. Timer test: Start 1-minute session, verify countdown updates every second
3. Wait Mode test:
   - Tap mic/make noise - should NOT trigger
   - Play correct note briefly (<150ms) - should NOT trigger
   - Play correct note sustained (>150ms) - should trigger green
   - Let note decay - should NOT trigger octave jump errors

---

## Notes

- This phase was inserted via `/gsd-insert-phase` after Phase 3 UAT
- Decimal numbering (3.1) indicates insertion between planned phases
- All fixes are isolated to specific files with clear root causes from UAT diagnosis
